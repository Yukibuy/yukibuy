<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YukiBuy - Upload Robuste</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .upload-section {
            padding: 40px;
        }
        
        .dropzone {
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .dropzone.dragover {
            border-color: #ff6b6b;
            background-color: #fff5f5;
        }
        
        .dropzone.uploading {
            pointer-events: none;
            opacity: 0.7;
        }
        
        .dropzone-icon {
            font-size: 4em;
            color: #ddd;
            margin-bottom: 20px;
        }
        
        .dropzone.dragover .dropzone-icon {
            color: #ff6b6b;
        }
        
        .file-input {
            display: none;
        }
        
        .file-list {
            margin: 20px 0;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .file-info {
            flex-grow: 1;
        }
        
        .file-name {
            font-weight: bold;
            color: #333;
        }
        
        .file-size {
            color: #666;
            font-size: 0.9em;
        }
        
        .file-mode {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .file-mode.resumable {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .progress-container {
            margin-top: 20px;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4caf50, #8bc34a);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .progress-text {
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255,107,107,0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #cce5ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }
        
        .tech-notes {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            margin: 30px 0;
            padding: 20px;
            border-radius: 0 8px 8px 0;
        }
        
        .tech-notes h3 {
            color: #007bff;
            margin-bottom: 15px;
        }
        
        .tech-notes ul {
            margin: 10px 0 10px 20px;
        }
        
        .tech-notes li {
            margin: 5px 0;
        }
        
        .chunk-progress {
            margin: 10px 0;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ YukiBuy Upload</h1>
            <p>Upload robuste jusqu'√† 1GB+ avec reprise automatique</p>
        </div>
        
        <div class="upload-section">
            <div class="dropzone" id="dropzone">
                <div class="dropzone-icon">üìÅ</div>
                <h3>Glissez vos fichiers ici ou cliquez pour s√©lectionner</h3>
                <p>Formats accept√©s: CSV, XLSX, XLS, ZIP, PDF</p>
                <input type="file" id="fileInput" class="file-input" multiple accept=".csv,.xlsx,.xls,.zip,.pdf">
            </div>
            
            <div class="file-list" id="fileList"></div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-text" id="progressText">Pr√©paration...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="chunk-progress" id="chunkProgress"></div>
            </div>
            
            <div class="status" id="status"></div>
            
            <div class="controls">
                <button class="btn btn-primary" id="uploadBtn">üì§ D√©marrer l'upload</button>
                <button class="btn btn-secondary" id="cancelBtn" disabled>‚ùå Annuler</button>
            </div>
            
            <div class="tech-notes">
                <h3>üìã Notes techniques & limites</h3>
                <ul>
                    <li><strong>Quotas Apps Script :</strong> 6 min par ex√©cution, 90 min/jour par utilisateur</li>
                    <li><strong>Quota Google Drive :</strong> 750 GB/jour par utilisateur</li>
                    <li><strong>Taille par fichier :</strong> Support th√©orique > 1 GB (Drive), limit√© par browser RAM</li>
                    <li><strong>Mode simple :</strong> ‚â§ 100 KB (upload direct via JSONP)</li>
                    <li><strong>Mode r√©sumable :</strong> > 100 KB (chunks de 1 MB avec reprise automatique)</li>
                </ul>
                <p><strong>Bonnes pratiques :</strong> Compressez en ZIP si possible, √©vitez > 500 MB pour un meilleur confort.</p>
                
                <h4>üîß D√©ploiement Google Apps Script</h4>
                <ol>
                    <li>Coller le code dans <a href="https://script.google.com" target="_blank">script.google.com</a></li>
                    <li>Modifier les constantes FOLDER_ID, ALLOWED_ORIGIN, SCRIPT_SECRET</li>
                    <li>Deploy > New deployment > Web app</li>
                    <li>Execute as: Me, Who has access: Anyone</li>
                    <li>Coller l'URL dans APPS_SCRIPT_URL ci-dessous</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // üîß CONFIGURATION - √Ä PERSONNALISER
        // ========================================
        const CONFIG = {
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzj5eIZHLtkVZEvGLNIP6MV7ncah-R7Jb7myK2iiWX2tbXzE3uB6Vi2vEBpQ2YFl9AL/exec',
            SIMPLE_THRESHOLD: 100 * 1024, // 100 KB - Maximum s√©curis√© pour JSONP URLs
            CHUNK_SIZE: 1 * 1024 * 1024, // 1 MB chunks pour r√©sumable
            SECRET: 'yukibuy_upload_2024',
            ALLOWED_TYPES: ['.csv', '.xlsx', '.xls', '.zip', '.pdf'],
            MAX_FILE_SIZE: 1024 * 1024 * 1024 // 1 GB
        };

        // ========================================
        // VARIABLES GLOBALES
        // ========================================
        let selectedFiles = [];
        let isUploading = false;
        let cancelToken = { cancelled: false };

        // Elements DOM
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const chunkProgress = document.getElementById('chunkProgress');
        const status = document.getElementById('status');
        const uploadBtn = document.getElementById('uploadBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        // ========================================
        // HELPERS
        // ========================================
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function uuid() {
            return 'xxxx-xxxx-4xxx-yxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        function hideStatus() {
            status.style.display = 'none';
        }

        // ========================================
        // GESTION FICHIERS
        // ========================================
        function validateFile(file) {
            // V√©rifier extension
            const extension = '.' + file.name.split('.').pop().toLowerCase();
            if (!CONFIG.ALLOWED_TYPES.includes(extension)) {
                showStatus(`Format non support√©: ${extension}. Utilisez: ${CONFIG.ALLOWED_TYPES.join(', ')}`, 'error');
                return false;
            }

            // Avertissement pour tr√®s gros fichiers
            if (file.size > CONFIG.MAX_FILE_SIZE) {
                showStatus(`Fichier tr√®s volumineux (${formatBytes(file.size)}). L'upload peut √™tre tr√®s long.`, 'info');
            }

            return true;
        }

        function addFile(file) {
            if (!validateFile(file)) return;

            // √âviter doublons
            const exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
            if (exists) {
                showStatus(`Fichier d√©j√† s√©lectionn√©: ${file.name}`, 'error');
                return;
            }

            selectedFiles.push(file);
            updateFileList();
            hideStatus();
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
        }

        function updateFileList() {
            if (selectedFiles.length === 0) {
                fileList.innerHTML = '';
                uploadBtn.disabled = true;
                return;
            }

            uploadBtn.disabled = false;

            fileList.innerHTML = selectedFiles.map((file, index) => {
                const isResumable = file.size > CONFIG.SIMPLE_THRESHOLD;
                return `
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-name">üìÑ ${file.name}</div>
                            <div class="file-size">${formatBytes(file.size)}</div>
                        </div>
                        <div>
                            <span class="file-mode ${isResumable ? 'resumable' : ''}">${isResumable ? 'R√©sumable' : 'Simple'}</span>
                            <button onclick="removeFile(${index})" style="background:none;border:none;color:#dc3545;font-size:1.2em;margin-left:10px;cursor:pointer;">‚ùå</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================
        dropzone.addEventListener('click', () => fileInput.click());

        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });

        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('dragover');
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            files.forEach(addFile);
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(addFile);
        });

        uploadBtn.addEventListener('click', startUpload);
        cancelBtn.addEventListener('click', cancelUpload);

        // ========================================
        // UPLOAD LOGIC
        // ========================================
        async function startUpload() {
            if (selectedFiles.length === 0) return;
            
            if (CONFIG.APPS_SCRIPT_URL.includes('TODO_REMPLACER')) {
                showStatus('‚ùå Configuration manquante: veuillez configurer APPS_SCRIPT_URL', 'error');
                return;
            }

            isUploading = true;
            cancelToken.cancelled = false;
            
            uploadBtn.disabled = true;
            cancelBtn.disabled = false;
            progressContainer.style.display = 'block';
            dropzone.classList.add('uploading');

            try {
                let completedFiles = 0;
                const totalFiles = selectedFiles.length;

                for (let i = 0; i < selectedFiles.length; i++) {
                    if (cancelToken.cancelled) break;

                    const file = selectedFiles[i];
                    progressText.textContent = `Fichier ${i + 1}/${totalFiles}: ${file.name}`;

                    try {
                        console.log(`üîç File size check: ${file.name} = ${formatBytes(file.size)}`);
                        console.log(`üîç SIMPLE_THRESHOLD: ${formatBytes(CONFIG.SIMPLE_THRESHOLD)}`);
                        
                        if (file.size <= CONFIG.SIMPLE_THRESHOLD) {
                            console.log(`‚û°Ô∏è Using uploadSimple for ${file.name}`);
                            await uploadSimple(file);
                        } else {
                            console.log(`‚û°Ô∏è Using uploadResumable for ${file.name}`);
                            await uploadResumable(file);
                        }
                        completedFiles++;
                    } catch (error) {
                        console.error(`Erreur upload ${file.name}:`, error);
                        showStatus(`‚ùå Erreur pour ${file.name}: ${error.message}`, 'error');
                        break;
                    }
                }

                if (!cancelToken.cancelled && completedFiles === totalFiles) {
                    showStatus(`‚úÖ Upload termin√© ! ${completedFiles} fichier(s) envoy√©(s) avec succ√®s.`, 'success');
                    selectedFiles = [];
                    updateFileList();
                }

            } catch (error) {
                console.error('Upload error:', error);
                showStatus(`‚ùå Erreur g√©n√©rale: ${error.message}`, 'error');
            } finally {
                isUploading = false;
                uploadBtn.disabled = false;
                cancelBtn.disabled = true;
                progressContainer.style.display = 'none';
                dropzone.classList.remove('uploading');
            }
        }

        function cancelUpload() {
            cancelToken.cancelled = true;
            showStatus('‚ö†Ô∏è Upload annul√© par l\'utilisateur', 'info');
        }

        // ========================================
        // UPLOAD SIMPLE VIA JSONP (TOUS FICHIERS)
        // ========================================
        async function uploadSimple(file) {
            console.log(`üì§ Upload simple JSONP: ${file.name} (${formatBytes(file.size)})`);

            // V√©rification taille avant traitement
            if (file.size > CONFIG.SIMPLE_THRESHOLD) {
                throw new Error(`Fichier trop volumineux pour mode simple (${formatBytes(file.size)} > ${formatBytes(CONFIG.SIMPLE_THRESHOLD)}). Utilisez le mode r√©sumable.`);
            }

            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        const bytesArray = Array.from(new Uint8Array(arrayBuffer));

                        console.log(`üì¶ Pr√©paration JSONP: ${bytesArray.length} bytes`);
                        
                        // V√©rification taille JSON (approximation: ~3.5x la taille originale)
                        const jsonSize = JSON.stringify(bytesArray).length;
                        console.log(`üìè Taille JSON estim√©e: ${formatBytes(jsonSize)}`);
                        
                        // Limite URL stricte pour √©viter ERR_CONNECTION_RESET
                        const maxUrlLength = 8000; // Limite conservatrice pour √©viter les erreurs serveur
                        const baseUrlLength = CONFIG.APPS_SCRIPT_URL.length + 200; // URL + params
                        const maxDataSize = maxUrlLength - baseUrlLength;
                        
                        if (jsonSize > maxDataSize) {
                            throw new Error(`Donn√©es trop volumineuses pour JSONP (${formatBytes(jsonSize)} JSON > ${formatBytes(maxDataSize)} max). Passez en mode r√©sumable.`);
                        }
                        
                        // Envoyer via JSONP (mode simple)
                        const result = await jsonpRequest({
                            mode: 'simple',
                            filename: file.name,
                            mimeType: file.type,
                            secret: CONFIG.SECRET,
                            fileData: JSON.stringify(bytesArray)
                        });

                        if (result.success) {
                            console.log(`‚úÖ Upload JSONP r√©ussi: ${file.name}`);
                            resolve(result);
                        } else {
                            throw new Error(result.message || 'Upload JSONP √©chou√©');
                        }

                    } catch (error) {
                        reject(error);
                    }
                };

                reader.onerror = () => reject(new Error('Erreur lecture fichier'));
                reader.readAsArrayBuffer(file);
            });
        }

        // ========================================
        // UPLOAD R√âSUMABLE (> 40MB) - JSONP
        // ========================================
        async function uploadResumable(file) {
            console.log(`‚òÅÔ∏è Upload r√©sumable: ${file.name} (${formatBytes(file.size)})`);

            // 1. Initialiser la session avec JSONP
            const initResult = await jsonpRequest({
                mode: 'init',
                filename: file.name,
                mimeType: file.type,
                fileSize: file.size.toString(),
                secret: CONFIG.SECRET
            });

            if (!initResult.success) {
                throw new Error(initResult.message || '√âchec initialisation');
            }

            const uploadId = initResult.uploadId;
            console.log(`üîÑ Session initialis√©e: ${uploadId}`);

            // 2. Upload par chunks
            let start = 0;
            const totalChunks = Math.ceil(file.size / CONFIG.CHUNK_SIZE);
            let chunkIndex = 0;

            while (start < file.size && !cancelToken.cancelled) {
                chunkIndex++;
                const end = Math.min(start + CONFIG.CHUNK_SIZE, file.size);
                const chunk = file.slice(start, end);

                chunkProgress.textContent = `Chunk ${chunkIndex}/${totalChunks} (${formatBytes(start)} ‚Üí ${formatBytes(end)})`;

                // Lire le chunk
                const chunkResult = await readChunk(chunk);
                
                // Envoyer le chunk via POST
                const chunkParams = new URLSearchParams({
                    mode: 'chunk',
                    uploadId: uploadId,
                    start: start,
                    end: end,
                    total: file.size,
                    secret: CONFIG.SECRET
                });

                const chunkResponse = await fetch(CONFIG.APPS_SCRIPT_URL + '?' + chunkParams.toString(), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(chunkResult)
                });

                const chunkResultJson = await chunkResponse.json();

                if (!chunkResultJson.success) {
                    throw new Error(chunkResultJson.message || 'Erreur chunk');
                }

                // Mettre √† jour la progression
                const progress = Math.round((end / file.size) * 100);
                progressFill.style.width = `${progress}%`;

                if (chunkResultJson.completed) {
                    console.log(`‚úÖ Upload r√©sumable termin√©: ${file.name}`);
                    chunkProgress.textContent = 'Upload termin√© !';
                    return chunkResultJson;
                }

                start = chunkResultJson.nextStart;
                await sleep(100); // Petite pause entre chunks
            }

            if (cancelToken.cancelled) {
                throw new Error('Upload annul√©');
            }
        }

        function readChunk(chunk) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const arrayBuffer = e.target.result;
                    const bytesArray = Array.from(new Uint8Array(arrayBuffer));
                    resolve(bytesArray);
                };
                reader.onerror = () => reject(new Error('Erreur lecture chunk'));
                reader.readAsArrayBuffer(chunk);
            });
        }

        // ========================================
        // HELPER JSONP - CONTOURNEMENT CORS
        // ========================================
        function jsonpRequest(params) {
            return new Promise((resolve, reject) => {
                console.log('üìû JSONP request starting...', Object.keys(params));
                
                const callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
                
                // Cr√©er callback global temporaire
                window[callbackName] = function(data) {
                    console.log('‚úÖ JSONP callback received:', data);
                    delete window[callbackName];
                    if (document.head.contains(script)) {
                        document.head.removeChild(script);
                    }
                    resolve(data);
                };
                
                // Cr√©er script tag
                const script = document.createElement('script');
                const url = new URL(CONFIG.APPS_SCRIPT_URL);
                
                // Ajouter tous les param√®tres + callback
                Object.keys(params).forEach(key => {
                    if (key === 'fileData') {
                        console.log(`üì¶ Adding fileData: ${params[key].length} chars`);
                    }
                    url.searchParams.append(key, params[key]);
                });
                url.searchParams.append('callback', callbackName);
                
                const finalUrl = url.toString();
                console.log(`üåê JSONP URL length: ${finalUrl.length} chars`);
                console.log(`üåê JSONP URL preview: ${finalUrl.substring(0, 200)}...`);
                
                script.src = finalUrl;
                script.onerror = (error) => {
                    console.error('‚ùå JSONP script error:', error);
                    delete window[callbackName];
                    if (document.head.contains(script)) {
                        document.head.removeChild(script);
                    }
                    
                    // Messages d'erreur plus sp√©cifiques
                    const urlLength = finalUrl.length;
                    let errorMessage = 'JSONP request failed';
                    
                    if (urlLength > 8000) {
                        errorMessage = `URL trop longue (${urlLength} chars). Fichier trop volumineux pour mode simple.`;
                    } else if (urlLength > 2048) {
                        errorMessage = `URL potentiellement trop longue (${urlLength} chars). Serveur peut refuser la requ√™te.`;
                    }
                    
                    reject(new Error(errorMessage));
                };
                
                script.onload = () => {
                    console.log('üìú JSONP script loaded');
                };
                
                // Timeout apr√®s 30 secondes
                setTimeout(() => {
                    if (window[callbackName]) {
                        console.log('‚è∞ JSONP timeout');
                        delete window[callbackName];
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                        }
                        reject(new Error('JSONP request timeout'));
                    }
                }, 30000);
                
                console.log('üì§ Sending JSONP request...');
                document.head.appendChild(script);
            });
        }

        // ========================================
        // INITIALISATION
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ YukiBuy Upload System Ready');
            
            // V√©rifier configuration
            if (CONFIG.APPS_SCRIPT_URL.includes('TODO_REMPLACER')) {
                showStatus('‚ö†Ô∏è Configuration requise: veuillez configurer APPS_SCRIPT_URL', 'info');
            }
        });

        // Expose pour debug
        window.removeFile = removeFile;
        window.jsonpRequest = jsonpRequest; // Pour tests
    </script>
</body>
</html>